[toc]

# 两种典型问题（在RC隔离级别下）

## 1 不可重复读

：不可重复读问题是指在同一个事务内，多次查询同一数据可能得到不同的结果。这是因为在读已提交隔离级别下，事务每次读取数据时都会看到最新已提交的数据。因此，如果其他事务在当前事务的两次查询之间提交了对该数据的更改，那么当前事务的第二次查询将看到更新后的数据，从而导致不可重复读问题。

#### 举例说明：

假设事务T1在某一时间点查询了一条记录A，随后事务T2对记录A进行了修改并提交。接着，事务T1再次查询记录A，此时得到的结果与第一次查询的结果不同。这就是不可重复读问题。

## 2 幻读

幻读问题是指在一个事务内，两次查询范围相同，但由于其他事务插入或删除了数据，导致两次查询结果不一致的现象。在读已提交隔离级别下，由于事务能够看到其他事务已提交的更改，因此可能会出现幻读问题。

#### 举例说明：

假设事务T1查询了一个数据范围，得到了5条记录。随后，事务T2在该数据范围内插入了一条新记录并提交。接着，事务T1再次查询相同的数据范围，此时得到了6条记录。尽管事务T1没有对数据进行更改，但两次查询的结果仍然不同。这就是幻读问题。

# MVCC

## 1实现原理

在每行记录。增加了以下两个隐藏字段

数据行的版本号（DB_TRX_ID）,表示新增记录时的事务版本号；

删除版本号（DB_ROLL_PTR）,表示删除记录时的版本号

## 2 MVCC在RR隔离级别下：

### 1 insert

将DB_TRX_ID保存为当前的版本号

### 2 Delete

将DB_ROLL_PTR保存为当前的版本号

### 3 Update

是insert和delete的组合操作，同时将DB_TRX_ID和DB_ROLL_PTR保存为当前的版本号

### 4 Select

查找数据时满足两个条件：

#### 1 只查找DB_TRX_ID小于等于当前版本号的数据化。

这样查找的数据行，要么是已存在的记录，要么是本次事务中插入或修改的记录。

#### 2 DB_ROLL_PTR为未定义或大于当前版本号 

即本事务开始前，记录未被删除



