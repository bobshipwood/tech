upstream wsstaogui{
    server 8.134.55.79:15674 weight=1;
}
server{
listen 80;
server_name api.gzguixiansheng.com;
access_log off;
index index.html index.htm index.php;
root /mnt/wwwroot/yw;

#include enable-php-pathinfo.conf;

#wwc添加溯源代理start 
location ^~ /stdag/ {
    add_header 'Access-Control-Allow-Origin' *;
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-   Since,Keep-Alive,Origin,User-Agent,X-Requested-With';
    proxy_pass https://admin.stdag.cn/;
}

location ^~ /gzagri/ {
    add_header 'Access-Control-Allow-Origin' *;
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-   Since,Keep-Alive,Origin,User-Agent,X-Requested-With';
    proxy_pass http://gba.gzagri.gov.cn/;
}
location /trace { 
    rewrite             ^/trace:80/(.*)$ /$1 break;
    proxy_pass          http://gba.gzagri.gov.cn/api/v1.0.0/trace;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
}

location /wsstaogui/ {
        proxy_pass http://wsstaogui/;
        proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
#wwc添加溯源代理end

location / {
            index  index.htm index.html index.php;  
            if (!-e $request_filename){
                rewrite ^/(.*)$ /index.php?s=$1 last;
		#rewrite ^/(.*)$ /index.php/$1 last;
                break;
            }
        }
location ~ /.*\.php/ {
                rewrite ^(.*?/?)(.*\.php)(.*)$ /$2?s=$3 last;
                break;
        }
location ~ \.php {
    #fastcgi_pass unix:/dev/shm/php-cgi.sock;
    fastcgi_pass unix:/tmp/php-cgi5.6.sock;
    fastcgi_index index.php;
    include fastcgi_params;
    set $real_script_name $fastcgi_script_name;
        if ($fastcgi_script_name ~ "^(.+?\.php)(/.+)$") {
        set $real_script_name $1;
        }
    fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;
    fastcgi_param SCRIPT_NAME $real_script_name;
    }
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$ {
    expires 30d;
    access_log off;
    }
location ~ .*\.(js|css)?$ {
    expires 7d;
    access_log off;
    }
}

server{
listen 443 ssl;
server_name api.gzguixiansheng.com;
#ssl on;
access_log off;
index index.html index.htm index.php;
    ssl_certificate   /usr/local/nginx/conf/ssl/4765663_api.gzguixiansheng.com.pem;
    ssl_certificate_key  /usr/local/nginx/conf/ssl/4765663_api.gzguixiansheng.com.key;
    ssl_session_timeout 5m;
    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;
    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_prefer_server_ciphers on;

#include /usr/local/nginx/conf/rewrite/thinkphp.conf;
root /mnt/wwwroot/yw;


#wwc添加溯源代理start
location ^~ /stdag/ {
    add_header 'Access-Control-Allow-Origin' *;
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-   Since,Keep-Alive,Origin,User-Agent,X-Requested-With';
    proxy_pass https://admin.stdag.cn/;
}
location /traceV3Api {
    rewrite             ^/traceV3Api:80/(.*)$ /$1 break;
    proxy_pass          https://api.farm.stdag.cn/v1;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
}
location ^~ /gzagri/ {
    add_header 'Access-Control-Allow-Origin' *;
    add_header 'Access-Control-Allow-Credentials' 'true';
    add_header 'Access-Control-Allow-Methods' 'GET, OPTIONS';
    add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-   Since,Keep-Alive,Origin,User-Agent,X-Requested-With';
    proxy_pass http://gba.gzagri.gov.cn/;
}

location /wsstaogui/ {
        proxy_pass http://wsstaogui/;
        proxy_set_header HOST $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $remote_addr;

        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }

#wwc添加溯源代理end


location / {
            index  index.htm index.html index.php;  
            if (!-e $request_filename){
                #地址作为将参数rewrite到index.php上。tp框架接收s参数为controller和action，不少框架都利用这种方式来实现伪pathinfo模式（pathinfo为php功能，nginx并不支持）
               	rewrite ^/(.*)$ /index.php?s=$1 last;
		#rewrite ^/(.*)$ /index.php/$1 last;
                break;
            }
        }
location ~ /.*\.php/ {
                rewrite ^(.*?/?)(.*\.php)(.*)$ /$2?s=$3 last;
                break;
        }

location ~ \.php {
    #fastcgi_pass remote_php_ip:9000;
    #fastcgi_pass unix:/dev/shm/php-cgi.sock;
    fastcgi_pass unix:/tmp/php-cgi5.6.sock;
    fastcgi_index index.php;
    include fastcgi_params;
    set $real_script_name $fastcgi_script_name;
        if ($fastcgi_script_name ~ "^(.+?\.php)(/.+)$") {
        set $real_script_name $1;
        #set $path_info $2;
        }
    fastcgi_param SCRIPT_FILENAME $document_root$real_script_name;
    fastcgi_param SCRIPT_NAME $real_script_name;
    #fastcgi_param PATH_INFO $path_info;
    }
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|flv|ico)$ {
    expires 30d;
    access_log off;
    }
location ~ .*\.(js|css)?$ {
    expires 7d;
    access_log off;
    }
}
